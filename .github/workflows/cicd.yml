name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: travel_app_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DB_NAME: travel_app_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: "5432"
          REDIS_URL: redis://localhost:6379/0
        run: |
          python manage.py migrate

      - name: Run tests
        env:
          DB_NAME: travel_app_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: "5432"
          REDIS_URL: redis://localhost:6379/0
        run: |
          python manage.py test

      - name: Run linting
        run: |
          pip install flake8
          flake8 listings/ alx_travel_app/ --count --select=E9,F63,F7,F82 --show-source --statistics

  build-docker-image:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t travel_app:${{ github.sha }} .

      - name: Save Docker image
        run: |
          docker save travel_app:${{ github.sha }} > travel_app.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: travel_app.tar
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build-docker-image
    if: github.ref == 'refs/heads/main'
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "${{ secrets.DEPLOY_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Copy application files to server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }} mkdir -p /home/devops/travel_app
          rsync -av --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='*.pyc' \
            --exclude='.venv' \
            --exclude='venv' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='*.tar' \
            --exclude='.DS_Store' \
            . ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }}:/home/devops/travel_app/

      - name: Transfer Docker image to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new travel_app.tar ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }}:/tmp/

      - name: Create .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }} << 'EOF'
          cat > /home/devops/travel_app/.env << 'ENVEOF'
          DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}

          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_HOST=db
          DB_PORT=5432

          CORS_ALLOW_ALL_ORIGINS=False
          CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}

          CHAPA_SECRET_KEY=${{ secrets.CHAPA_SECRET_KEY }}

          CELERY_BROKER_URL=redis://redis:6379/0
          CELERY_RESULT_BACKEND=redis://redis:6379/0

          EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USE_TLS=True
          EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
          ENVEOF
          chmod 600 /home/devops/travel_app/.env
          EOF

      - name: Deploy to cloud server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }} << 'EOF'
          cd /home/devops/travel_app

          # Load the Docker image
          docker load < /tmp/travel_app.tar

          # Tag image as latest for docker-compose
          docker tag travel_app:${{ github.sha }} travel_app:latest

          # Stop running containers
          docker-compose down || true

          # Start new containers
          docker-compose up -d

          # Wait for DB to be ready
          echo "Waiting for database to be ready..."
          for i in {1..30}; do
            if docker-compose exec -T db pg_isready -U travel_user -d travel_db &>/dev/null; then
              echo "Database is ready!"
              break
            fi
            echo "Attempt $i - Database not ready yet, waiting..."
            sleep 2
          done

          # Run migrations
          echo "Running migrations..."
          docker-compose exec -T web python manage.py migrate

          # Collect static files
          echo "Collecting static files..."
          docker-compose exec -T web python manage.py collectstatic --noinput

          # Cleanup
          rm /tmp/travel_app.tar

          echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new ${{ env.SSH_USERNAME }}@${{ env.SERVER_IP }} << 'EOF'
          echo "Checking container status..."
          docker-compose -f /home/devops/travel_app/docker-compose.yaml ps

          echo "Testing health endpoint..."
          curl -f http://localhost:8000/health/ || echo "Health check may not be available yet"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/known_hosts
